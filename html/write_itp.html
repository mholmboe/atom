<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      -->
<title>write_itp</title>
<meta name="generator" content="MATLAB 24.2">
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
<meta name="DC.date" content="2025-04-23">
<meta name="DC.source" content="write_itp.m">
<style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style>
</head>
<body>
<div class="content">
<h2>Contents</h2>
<div>
<ul>
<li>
<a href="#2">write_itp.m</a>
</li>
<li>
<a href="#3">This function prints a gromacs .itp file from a itp struct</a>
</li>
<li>
<a href="#4">Please report bugs to <a href="mailto:michael.holmboe@umu.se">michael.holmboe@umu.se</a></a>
</li>
<li>
<a href="#5">Todo, varargin could be a distance_matrix whose values could be printed</a>
</li>
<li>
<a href="#6">to the bonds section...</a>
</li>
<li>
<a href="#7">Version</a>
</li>
<li>
<a href="#8">Contact</a>
</li>
<li>
<a href="#9">Create vars for the sections</a>
</li>
</ul>
</div>
<pre class="codeinput">
<span class="keyword">function</span> write_itp(itp,filename,varargin)
</pre>
<h2 id="2">write_itp.m</h2>
<h2 id="3">This function prints a gromacs .itp file from a itp struct</h2>
<h2 id="4">Please report bugs to <a href="mailto:michael.holmboe@umu.se">michael.holmboe@umu.se</a>
</h2>
<h2 id="5">Todo, varargin could be a distance_matrix whose values could be printed</h2>
<h2 id="6">to the bonds section...</h2>
<h2 id="7">Version</h2>
<p>3.00</p>
<h2 id="8">Contact</h2>
<p>Please report bugs to <a href="mailto:michael.holmboe@umu.se">michael.holmboe@umu.se</a>
</p>
<pre class="codeinput">format <span class="string">long</span>

<span class="keyword">if</span> nargin &gt; 2
    scale_sigma=varargin{1};
<span class="keyword">else</span>
    scale_sigma=1;
<span class="keyword">end</span>

<span class="keyword">if</span> nargin &gt; 3
    scale_epsilon=varargin{2};
<span class="keyword">else</span>
    scale_epsilon=1;
<span class="keyword">end</span>

<span class="keyword">if</span> nargin &gt; 4
    scale_charge=varargin{3};
<span class="keyword">else</span>
    scale_charge=1;
<span class="keyword">end</span>

<span class="comment">% natoms=size(itp.atoms.nr,1);</span>

<span class="keyword">if</span> regexp(filename,<span class="string">'.itp'</span>) ~= false
    filename = filename;
<span class="keyword">else</span>
    filename = strcat(filename,<span class="string">'.itp'</span>);
<span class="keyword">end</span>
</pre>
<h2 id="9">Create vars for the sections</h2>
<pre class="codeinput">names = fieldnames(itp);
<span class="keyword">for</span> i=1:length(names)
    eval([names{i} <span class="string">'=itp.'</span> names{i} <span class="string">';'</span>]);
<span class="keyword">end</span>

fid = fopen(filename, <span class="string">'wt'</span>);

<span class="comment">% fprintf(fid, '%s % s\r\n',';',filename);</span>
fprintf(fid, <span class="string">'%s % s\r\n'</span>,<span class="string">';'</span>,<span class="string">'Modifed itp file written by MHolmboe (michael.holmboe@umu.se)'</span>);
fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'atomtypes'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">'[ atomtypes ]'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">'; name   bond_type  mass     charge   ptype   sigma        epsilon   ;'</span>);
    <span class="keyword">if</span> isfield(itp.atomtypes,<span class="string">'v'</span>)
        <span class="keyword">for</span> i = 1:size(itp.atomtypes.type,1)
            fprintf(fid, <span class="string">'%-6s   %3s   %10.5f  %10.5f  %5s   %10.6e  %10.6e\r\n'</span>,char(itp.atomtypes.type(i)),itp.atomtypes.atnum(i),scale_charge*itp.atomtypes.charge(i),char(itp.atomtypes.ptype(i)),scale_sigma*itp.atomtypes.v(i),scale_epsilon*itp.atomtypes.w(i));
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        <span class="keyword">for</span> i = 1:size(itp.atomtypes.type,1)
            fprintf(fid, <span class="string">'%-6s   %3i   %10.5f  %10.5f  %5s   %10.6e  %10.6e\r\n'</span>,char(itp.atomtypes.type(i)),itp.atomtypes.atnum(i),itp.atomtypes.mass(i),scale_charge*itp.atomtypes.charge(i),char(itp.atomtypes.ptype(i)),scale_sigma*itp.atomtypes.sigma(i),scale_epsilon*itp.atomtypes.epsilon(i));
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'pairtypes'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'[ pairtypes ] \r\n'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';  ai    aj   funct    c0     c1'</span>);
    <span class="keyword">if</span> numel(itp.pairtypes)&gt;0
        <span class="keyword">for</span> i = 1:size(itp.pairtypes.ai,1)
            <span class="keyword">if</span> numel(fieldnames(itp.pairtypes))==5 &amp;&amp; ~isnan(itp.pairtypes.c1(i))
                Bond_order(i,:)= {char(itp.pairtypes.ai(i)),char(itp.pairtypes.aj(i)),itp.pairtypes.funct(i),itp.pairtypes.c0(i),itp.pairtypes.c1(i)};
                fprintf(fid, <span class="string">'%-6s   %-6s  %3i    %10.6e  %10.6e\r\n'</span>, Bond_order{i,:});
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'bondtypes'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'[ bondtypes ] \r\n'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';  ai    aj funct       c0        c1        c2         c3'</span>);
    <span class="keyword">if</span> numel(itp.bondtypes)&gt;0
        <span class="keyword">for</span> i = 1:size(itp.bondtypes.ai,1)
            <span class="keyword">if</span> numel(fieldnames(itp.bondtypes))==4 &amp;&amp; ~isnan(itp.bondtypes.c0(i))
                Bond_order(i,:)= {char(itp.bondtypes.ai(i)),char(itp.bondtypes.aj(i)),itp.bondtypes.funct(i),itp.bondtypes.c0(i)};
                fprintf(fid, <span class="string">'%-6s   %-6s  %5i %10.5f\r\n'</span>, Bond_order{i,:});
            <span class="keyword">elseif</span> numel(fieldnames(itp.bondtypes))==5 &amp;&amp; ~isnan(itp.bondtypes.c1(i))
                Bond_order(i,:)= {char(itp.bondtypes.ai(i)),char(itp.bondtypes.aj(i)),itp.bondtypes.funct(i),itp.bondtypes.c0(i),itp.bondtypes.c1(i)};
                fprintf(fid, <span class="string">'%-6s   %-6s  %5i %10.5f  %10.2f\r\n'</span>, Bond_order{i,:});
            <span class="keyword">elseif</span> numel(fieldnames(itp.bondtypes))==6 &amp;&amp; ~isnan(itp.bondtypes.c2(i))
                Bond_order(i,:)= {char(itp.bondtypes.ai(i)),char(itp.bondtypes.aj(i)),itp.bondtypes.funct(i),itp.bondtypes.c0(i),itp.bondtypes.c1(i),itp.bondtypes.c2(i)};
                fprintf(fid, <span class="string">'%-6s   %-6s  %5i %10.5f  %10.5f  %10.2f\r\n'</span>, Bond_order{i,:});
            <span class="keyword">elseif</span> numel(fieldnames(itp.bondtypes))==7 &amp;&amp; ~isnan(itp.bondtypes.c3(i))
                Bond_order(i,:)= {char(itp.bondtypes.ai(i)),char(itp.bondtypes.aj(i)),itp.bondtypes.funct(i),itp.bondtypes.c0(i),itp.bondtypes.c1(i),itp.bondtypes.c2(i),itp.bondtypes.c3(i)};
                fprintf(fid, <span class="string">'%-6s   %-6s  %5i %10.5f  %10.5f  %10.5f  %10.2f\r\n'</span>, Bond_order{i,:});
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'angletypes'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'[ angletypes ] \r\n'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';  ai    aj    ak   funct       c0        c1        c2         c3'</span>);
    <span class="keyword">if</span> numel(itp.angletypes)&gt;0
        <span class="keyword">for</span> i = 1:size(itp.angletypes.ai,1)
            <span class="keyword">if</span> numel(fieldnames(itp.angletypes))==5 &amp;&amp; ~isnan(itp.angletypes.c0(i))
                Angle_order(i,:)= {char(itp.angletypes.ai(i)),char(itp.angletypes.aj(i)),char(itp.angletypes.ak(i)),itp.angletypes.funct(i),itp.angletypes.c0(i)};
                fprintf(fid, <span class="string">'%-6s   %-6s   %-6s   %3i  %10.5f\r\n'</span>, Angle_order{i,:});
            <span class="keyword">elseif</span> numel(fieldnames(itp.angletypes))==6 &amp;&amp; ~isnan(itp.angletypes.c1(i))
                Angle_order(i,:)= {char(itp.angletypes.ai(i)),char(itp.angletypes.aj(i)),char(itp.angletypes.ak(i)),itp.angletypes.funct(i),itp.angletypes.c0(i),itp.angletypes.c1(i)};
                fprintf(fid, <span class="string">'%-6s   %-6s   %-6s   %3i  %10.5f %10.2f\r\n'</span>, Angle_order{i,:});
            <span class="keyword">elseif</span> numel(fieldnames(itp.angletypes))==7 &amp;&amp; ~isnan(itp.angletypes.c2(i))
                Angle_order(i,:)= {char(itp.angletypes.ai(i)),char(itp.angletypes.aj(i)),char(itp.angletypes.ak(i)),itp.angletypes.funct(i),itp.angletypes.c0(i),itp.angletypes.c1(i),itp.angletypes.c2(i)};
                fprintf(fid, <span class="string">'%-6s   %-6s   %-6s   %3i  %10.5f  %10.5f %10.2f\r\n'</span>, Angle_order{i,:});
            <span class="keyword">elseif</span> numel(fieldnames(itp.angletypes))==8 &amp;&amp; ~isnan(itp.angletypes.c3(i))
                Angle_order(i,:)= {char(itp.angletypes.ai(i)),char(itp.angletypes.aj(i)),char(itp.angletypes.ak(i)),itp.angletypes.funct(i),itp.angletypes.c0(i),itp.angletypes.c1(i),itp.angletypes.c2(i),itp.angletypes.c3(i)};
                fprintf(fid, <span class="string">'%-6s   %-6s   %-6s   %3i  %10.5f  %10.5f  %10.5f %10.2f\r\n'</span>, Angle_order{i,:});
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'dihedraltypes'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'[ dihedraltypes ] \r\n'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';  ai    aj    ak    al funct            c0            c1            c2  '</span>);
    <span class="keyword">if</span> numel(itp.dihedraltypes)&gt;0
        <span class="keyword">for</span> i = 1:size(itp.dihedraltypes.ai,1)
            <span class="keyword">if</span> numel(fieldnames(itp.dihedraltypes))==8
                <span class="keyword">if</span> isfield(itp.dihedraltypes,<span class="string">'c0'</span>) &amp;&amp; ~isnan(itp.dihedraltypes.c0(i))
                    Dihedral_order(i,:)= {char(itp.dihedraltypes.ai(i)),char(itp.dihedraltypes.aj(i)),char(itp.dihedraltypes.ak(i)),char(itp.dihedraltypes.al(i)),itp.dihedraltypes.funct(i),itp.dihedraltypes.c0(i),itp.dihedraltypes.c1(i),itp.dihedraltypes.c2(i)};
                    fprintf(fid, <span class="string">'%6s   %6s   %6s   %6s %3i   %10.5f   %10.5f   %3i\r\n'</span>, Dihedral_order{i,:});
                <span class="keyword">else</span>
                    disp(<span class="string">'Did not write all dihedral params, need to edit a new section for that...'</span>)
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'dihedraltypes2'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'[ dihedraltypes ] \r\n'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';  ai    aj    ak    al funct            c0            c1  '</span>);
    <span class="keyword">if</span> numel(itp.dihedraltypes2)&gt;0
        <span class="keyword">for</span> i = 1:size(itp.dihedraltypes2.ai,1)
            <span class="keyword">if</span> numel(fieldnames(itp.dihedraltypes2))==7
                <span class="keyword">if</span> isfield(itp.dihedraltypes2,<span class="string">'c0'</span>) &amp;&amp; ~isnan(itp.dihedraltypes2.c0(i))
                    Dihedral2_order(i,:)= {char(itp.dihedraltypes2.ai(i)),char(itp.dihedraltypes2.aj(i)),char(itp.dihedraltypes2.ak(i)),char(itp.dihedraltypes2.al(i)),itp.dihedraltypes2.funct(i),itp.dihedraltypes2.c0(i),itp.dihedraltypes2.c1(i)};
                    fprintf(fid, <span class="string">'%6s   %6s   %6s   %6s %3i   %10.5f   %10.5f\r\n'</span>, Dihedral2_order{i,:});
                <span class="keyword">else</span>
                    disp(<span class="string">'Did not write all dihedral params, need to edit a new section for that...'</span>)
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'moleculetype'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">'[ moleculetype ]'</span>);
    fprintf(fid, <span class="string">'%s % s\r\n'</span>,<span class="string">';'</span>,<span class="string">'molname   nrexcl'</span>);
    fprintf(fid, <span class="string">'%s       %d\r\n'</span>,char(itp.moleculetype.moleculetype),str2double(itp.moleculetype.nrexcl));
    fprintf(fid, <span class="string">'\r\n'</span>);
<span class="keyword">end</span>

<span class="keyword">if</span> exist(<span class="string">'atoms'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">'[ atoms ]'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';    nr       type resnr residue  atom   cgnr     charge       mass     ; comment'</span>);
    ChargeSumColumn=round2dec(cumsum(itp.atoms.charge),5);
    <span class="keyword">for</span> i = 1:size(itp.atoms.nr,1)
        atoms_section(i,:) = {itp.atoms.nr(i), char(atoms.type(i)),itp.atoms.resnr(i),char(itp.atoms.residue(i)),char(itp.atoms.atom(i)),itp.atoms.nr(i), scale_charge*itp.atoms.charge(i),itp.atoms.mass(i), <span class="string">'; qtot '</span>, scale_charge*ChargeSumColumn(i)};
        fprintf(fid, <span class="string">'%6i%11s%9i%5s%7s%7i\t%8.5f\t%8.4f\t%5s\t%8.5f\r\n'</span>,atoms_section{i,:});
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'pairs'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'[ pairs ] \r\n'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';  ai    aj funct            c0            c1            c2            c3'</span>);
    <span class="keyword">if</span> numel(itp.pairs)&gt;0
        <span class="keyword">for</span> i = 1:size(itp.pairs.ai,1)
            <span class="keyword">if</span> numel(fieldnames(itp.pairs))&lt;5
                <span class="keyword">if</span> isfield(itp.pairs,<span class="string">'c0'</span>)<span class="comment">% ~isnan(itp.pairs.c0(i))</span>
                    Pair_order(i,:)= {itp.pairs.ai(i),itp.pairs.aj(i),itp.pairs.funct(i),itp.pairs.c0(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.pairs.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.pairs.aj(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %12.2e %s %s %s\r\n'</span>, Pair_order{i,:});
                <span class="keyword">else</span>
                    Pair_order(i,:)= {itp.pairs.ai(i),itp.pairs.aj(i),itp.pairs.funct(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.pairs.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.pairs.aj(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %s %s %s\r\n'</span>, Pair_order{i,:});
                <span class="keyword">end</span>
            <span class="keyword">elseif</span> isnan(itp.pairs.c0(i))
                Pair_order(i,:)= {itp.pairs.ai(i),itp.pairs.aj(i),itp.pairs.funct(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.pairs.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.pairs.aj(i)==itp.atoms.nr))};
                fprintf(fid, <span class="string">'%5i %5i %5i %s %s %s\r\n'</span>, Pair_order{i,:});
            <span class="keyword">else</span>
                disp(<span class="string">'Did not write all pair params, need to edit a new section for that...'</span>)
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'bonds'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'[ bonds ] \r\n'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';  ai    aj funct       c0        c1        c2         c3'</span>);
    <span class="keyword">if</span> numel(itp.bonds)&gt;0
        <span class="keyword">for</span> i = 1:size(itp.bonds.ai,1)
            <span class="keyword">if</span> numel(fieldnames(itp.bonds))&lt;5
                <span class="keyword">if</span> isfield(itp.bonds,<span class="string">'c0'</span>) &amp;&amp; ~isnan(itp.bonds.c0(i)) &amp;&amp; ~itp.bonds.c0(i)==0
                    Bond_order(i,:)= {itp.bonds.ai(i),itp.bonds.aj(i),itp.bonds.funct(i),itp.bonds.c0(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.bonds.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.bonds.aj(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %10.5f %s %s %s\r\n'</span>, Bond_order{i,:});
                <span class="keyword">else</span>
                    Bond_order(i,:)= {itp.bonds.ai(i),itp.bonds.aj(i),itp.bonds.funct(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.bonds.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.bonds.aj(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %s %s %s\r\n'</span>, Bond_order{i,:});
                <span class="keyword">end</span>
            <span class="keyword">elseif</span> numel(fieldnames(itp.bonds))&lt;6
                <span class="keyword">if</span> isfield(itp.bonds,<span class="string">'c1'</span>) &amp;&amp; ~isnan(itp.bonds.c0(i)) &amp;&amp; ~itp.bonds.c0(i)==0
                    Bond_order(i,:)= {itp.bonds.ai(i),itp.bonds.aj(i),itp.bonds.funct(i),itp.bonds.c0(i),itp.bonds.c1(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.bonds.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.bonds.aj(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %10.5f %10.2f %s %s %s\r\n'</span>, Bond_order{i,:});
                <span class="keyword">else</span>
                    numel(fieldnames(itp.bonds))
                    fieldnames(itp.bonds)
                    disp(<span class="string">'Did not write all bonded params, need to edit a new section for that...'</span>)
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                numel(fieldnames(itp.bonds))
                fieldnames(itp.bonds)
                disp(<span class="string">'Did not write all bonded params, need to edit a new section for that...'</span>)
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);


<span class="keyword">if</span> exist(<span class="string">'angles'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'[ angles ] \r\n'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';  ai    aj    ak  funct      c0           c1         c2         c3'</span>);
    <span class="keyword">if</span> numel(itp.angles)&gt;0
        <span class="keyword">for</span> i = 1:size(itp.angles.ai,1)
            <span class="keyword">if</span> numel(fieldnames(itp.angles))&lt;6
                <span class="keyword">if</span> isfield(itp.angles,<span class="string">'c0'</span>) &amp;&amp; ~isnan(itp.angles.c0(i)) &amp;&amp; ~itp.angles.c0(i)==0
                    Angle_order(i,:)= {itp.angles.ai(i),itp.angles.aj(i),itp.angles.ak(i),itp.angles.funct(i),itp.angles.c0(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.angles.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.ak(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %5i %10.2f %s %s %s %s\r\n'</span>, Angle_order{i,:});
                <span class="keyword">else</span>
                    Angle_order(i,:)= {itp.angles.ai(i),itp.angles.aj(i),itp.angles.ak(i),itp.angles.funct(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.angles.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.ak(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %5i %s %s %s %s\r\n'</span>, Angle_order{i,:});
                <span class="keyword">end</span>
            <span class="keyword">elseif</span> numel(fieldnames(itp.angles))&lt;7
                <span class="keyword">if</span> isfield(itp.angles,<span class="string">'c1'</span>) &amp;&amp; ~isnan(itp.angles.c0(i)) &amp;&amp; ~itp.angles.c0(i)==0
                    Angle_order(i,:)= {itp.angles.ai(i),itp.angles.aj(i),itp.angles.ak(i),itp.angles.funct(i),itp.angles.c0(i),itp.angles.c1(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.angles.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.ak(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %5i %10.2f %10.2f %s %s %s %s\r\n'</span>, Angle_order{i,:});
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                disp(<span class="string">'Did not write all angle params, need to edit a new section for that...'</span>)
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'exclusions'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'[ exclusions ] \r\n'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';  ai    aj    ak  funct'</span>);
    <span class="keyword">if</span> numel(itp.exclusions)&gt;0
        <span class="keyword">for</span> i = 1:size(itp.exclusions.ai,1)
            <span class="keyword">if</span> numel(fieldnames(itp.exclusions))&lt;5
                <span class="keyword">if</span> ~isnan(itp.exclusions.c0(i))
                    Exclusion_order(i,:)= {itp.exclusions.ai(i),itp.exclusions.aj(i),itp.exclusions.ak(i),itp.exclusions.funct(i),itp.exclusions.c0(i)};
                    fprintf(fid, <span class="string">'%5i %5i %5i %5i %8.2f\r\n'</span>, Exclusion_order{i,:});
                <span class="keyword">else</span>
                    Exclusion_order(i,:)= {itp.exclusions.ai(i),itp.exclusions.aj(i),itp.exclusions.ak(i),itp.exclusions.funct(i)};
                    fprintf(fid, <span class="string">'%5i %5i %5i %5i\r\n'</span>, Exclusion_order{i,:});
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                disp(<span class="string">'Did not write all exclusion params, need to edit a new section for that...'</span>)
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'dihedrals'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'[ dihedrals ] \r\n'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';  ai    aj    ak    al funct            c0            c1            c2            c3            c4            c5'</span>);
    <span class="keyword">if</span> numel(itp.dihedrals)&gt;0
        <span class="keyword">for</span> i = 1:size(itp.dihedrals.ai,1)
            <span class="keyword">if</span> numel(fieldnames(itp.dihedrals))&lt;7
                <span class="keyword">if</span> isfield(itp.dihedrals,<span class="string">'c0'</span>) &amp;&amp; ~isnan(itp.dihedrals.c0(i))
                    Dihedral_order(i,:)= {itp.dihedrals.ai(i),itp.dihedrals.aj(i),itp.dihedrals.ak(i),itp.dihedrals.al(i),itp.dihedrals.funct(i),itp.dihedrals.c0(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.dihedrals.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.al(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %5i %5i %8.2f %s %s %s %s %s\r\n'</span>, Dihedral_order{i,:});
                <span class="keyword">else</span>
                    Dihedral_order(i,:)= {itp.dihedrals.ai(i),itp.dihedrals.aj(i),itp.dihedrals.ak(i),itp.dihedrals.al(i),itp.dihedrals.funct(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.dihedrals.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.al(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %5i %5i %s %s %s %s %s\r\n'</span>, Dihedral_order{i,:});
                <span class="keyword">end</span>
            <span class="keyword">elseif</span> numel(fieldnames(itp.dihedrals))&lt;8
                <span class="keyword">if</span> isfield(itp.dihedrals,<span class="string">'c2'</span>) &amp;&amp; ~isnan(itp.dihedrals.c2(i))
                    Dihedral_order(i,:)= {itp.dihedrals.ai(i),itp.dihedrals.aj(i),itp.dihedrals.ak(i),itp.dihedrals.al(i),itp.dihedrals.funct(i),itp.dihedrals.c0(i),itp.dihedrals.c1(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.dihedrals.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.al(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %5i %5i %8.2f %8.4f %s %s %s %s %s\r\n'</span>, Dihedral_order{i,:});
                <span class="keyword">end</span>
            <span class="keyword">elseif</span> numel(fieldnames(itp.dihedrals))&gt;8
                <span class="keyword">if</span> isfield(itp.dihedrals,<span class="string">'c2'</span>) &amp;&amp; ~isnan(itp.dihedrals.c2(i))
                    Dihedral_order(i,:)= {itp.dihedrals.ai(i),itp.dihedrals.aj(i),itp.dihedrals.ak(i),itp.dihedrals.al(i),itp.dihedrals.funct(i),itp.dihedrals.c0(i),itp.dihedrals.c1(i),itp.dihedrals.c2(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.dihedrals.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.al(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %5i %5i %8.2f %8.4f %5i %s %s %s %s %s\r\n'</span>, Dihedral_order{i,:});
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                disp(<span class="string">'Did not write all dihedral params, need to edit a new section for that...'</span>)
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'impropers'</span>,<span class="string">'var'</span>)
    fprintf(fid, <span class="string">'[ impropers ] \r\n'</span>);
    fprintf(fid, <span class="string">'%s\r\n'</span>,<span class="string">';  ai    aj    ak    al funct            c0            c1            c2            c3            c4            c5'</span>);
    <span class="keyword">if</span> numel(itp.impropers)&gt;0
        <span class="keyword">for</span> i = 1:size(itp.impropers.ai,1)
            <span class="keyword">if</span> numel(fieldnames(itp.impropers))&lt;7
                <span class="keyword">if</span> isfield(itp.impropers,<span class="string">'c0'</span>) &amp;&amp; ~isnan(itp.impropers.c0(i))
                    Improper_order(i,:)= {itp.impropers.ai(i),itp.impropers.aj(i),itp.impropers.ak(i),itp.impropers.al(i),itp.impropers.funct(i),itp.impropers.c0(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.impropers.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.al(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %5i %5i %8.2f %s %s %s %s %s\r\n'</span>, Improper_order{i,:});
                <span class="keyword">else</span>
                    Improper_order(i,:)= {itp.impropers.ai(i),itp.impropers.aj(i),itp.impropers.ak(i),itp.impropers.al(i),itp.impropers.funct(i),<span class="string">';'</span>,char(itp.atoms.atom(itp.impropers.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.al(i)==itp.atoms.nr))};
                    fprintf(fid, <span class="string">'%5i %5i %5i %5i %5i %s %s %s %s %s\r\n'</span>, Improper_order{i,:});
                <span class="keyword">end</span>
            <span class="keyword">else</span>
                disp(<span class="string">'Did not write all improper params, need to edit a new section for that...'</span>)
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

<span class="keyword">if</span> exist(<span class="string">'enddata'</span>,<span class="string">'var'</span>)
    end_string=cellstr(itp.enddata);
    fprintf(fid, <span class="string">'%s \r\n'</span>,end_string{:});
<span class="keyword">end</span>

fprintf(fid, <span class="string">'\r\n'</span>);

fclose(fid);
</pre>
<p class="footer">
<br>
<a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2024b</a>
<br>
</p>
</div>
<!--
##### SOURCE BEGIN #####
function write_itp(itp,filename,varargin)
%% write_itp.m
%% This function prints a gromacs .itp file from a itp struct
%% Please report bugs to michael.holmboe@umu.se
%% Todo, varargin could be a distance_matrix whose values could be printed
%% to the bonds section...
%
%% Version
% 3.00
%
%% Contact
% Please report bugs to michael.holmboe@umu.se

format long

if nargin > 2
    scale_sigma=varargin{1};
else
    scale_sigma=1;
end

if nargin > 3
    scale_epsilon=varargin{2};
else
    scale_epsilon=1;
end

if nargin > 4
    scale_charge=varargin{3};
else
    scale_charge=1;
end

% natoms=size(itp.atoms.nr,1);

if regexp(filename,'.itp') ~= false
    filename = filename;
else
    filename = strcat(filename,'.itp');
end

%% Create vars for the sections
names = fieldnames(itp);
for i=1:length(names)
    eval([names{i} '=itp.' names{i} ';']);
end

fid = fopen(filename, 'wt');

% fprintf(fid, '%s % s\r\n',';',filename);
fprintf(fid, '%s % s\r\n',';','Modifed itp file written by MHolmboe (michael.holmboe@umu.se)');
fprintf(fid, '\r\n');

if exist('atomtypes','var')
    fprintf(fid, '%s\r\n','[ atomtypes ]');
    fprintf(fid, '%s\r\n','; name   bond_type  mass     charge   ptype   sigma        epsilon   ;');
    if isfield(itp.atomtypes,'v')
        for i = 1:size(itp.atomtypes.type,1)
            fprintf(fid, '%-6s   %3s   %10.5f  %10.5f  %5s   %10.6e  %10.6e\r\n',char(itp.atomtypes.type(i)),itp.atomtypes.atnum(i),scale_charge*itp.atomtypes.charge(i),char(itp.atomtypes.ptype(i)),scale_sigma*itp.atomtypes.v(i),scale_epsilon*itp.atomtypes.w(i));
        end
    else
        for i = 1:size(itp.atomtypes.type,1)
            fprintf(fid, '%-6s   %3i   %10.5f  %10.5f  %5s   %10.6e  %10.6e\r\n',char(itp.atomtypes.type(i)),itp.atomtypes.atnum(i),itp.atomtypes.mass(i),scale_charge*itp.atomtypes.charge(i),char(itp.atomtypes.ptype(i)),scale_sigma*itp.atomtypes.sigma(i),scale_epsilon*itp.atomtypes.epsilon(i));
        end
    end
end

fprintf(fid, '\r\n');

if exist('pairtypes','var')
    fprintf(fid, '[ pairtypes ] \r\n');
    fprintf(fid, '%s\r\n',';  ai    aj   funct    c0     c1');
    if numel(itp.pairtypes)>0
        for i = 1:size(itp.pairtypes.ai,1)
            if numel(fieldnames(itp.pairtypes))==5 && ~isnan(itp.pairtypes.c1(i))
                Bond_order(i,:)= {char(itp.pairtypes.ai(i)),char(itp.pairtypes.aj(i)),itp.pairtypes.funct(i),itp.pairtypes.c0(i),itp.pairtypes.c1(i)};
                fprintf(fid, '%-6s   %-6s  %3i    %10.6e  %10.6e\r\n', Bond_order{i,:});
            end
        end
    end
end

fprintf(fid, '\r\n');

if exist('bondtypes','var')
    fprintf(fid, '[ bondtypes ] \r\n');
    fprintf(fid, '%s\r\n',';  ai    aj funct       c0        c1        c2         c3');
    if numel(itp.bondtypes)>0
        for i = 1:size(itp.bondtypes.ai,1)
            if numel(fieldnames(itp.bondtypes))==4 && ~isnan(itp.bondtypes.c0(i))
                Bond_order(i,:)= {char(itp.bondtypes.ai(i)),char(itp.bondtypes.aj(i)),itp.bondtypes.funct(i),itp.bondtypes.c0(i)};
                fprintf(fid, '%-6s   %-6s  %5i %10.5f\r\n', Bond_order{i,:});
            elseif numel(fieldnames(itp.bondtypes))==5 && ~isnan(itp.bondtypes.c1(i))
                Bond_order(i,:)= {char(itp.bondtypes.ai(i)),char(itp.bondtypes.aj(i)),itp.bondtypes.funct(i),itp.bondtypes.c0(i),itp.bondtypes.c1(i)};
                fprintf(fid, '%-6s   %-6s  %5i %10.5f  %10.2f\r\n', Bond_order{i,:});
            elseif numel(fieldnames(itp.bondtypes))==6 && ~isnan(itp.bondtypes.c2(i))
                Bond_order(i,:)= {char(itp.bondtypes.ai(i)),char(itp.bondtypes.aj(i)),itp.bondtypes.funct(i),itp.bondtypes.c0(i),itp.bondtypes.c1(i),itp.bondtypes.c2(i)};
                fprintf(fid, '%-6s   %-6s  %5i %10.5f  %10.5f  %10.2f\r\n', Bond_order{i,:});
            elseif numel(fieldnames(itp.bondtypes))==7 && ~isnan(itp.bondtypes.c3(i))
                Bond_order(i,:)= {char(itp.bondtypes.ai(i)),char(itp.bondtypes.aj(i)),itp.bondtypes.funct(i),itp.bondtypes.c0(i),itp.bondtypes.c1(i),itp.bondtypes.c2(i),itp.bondtypes.c3(i)};
                fprintf(fid, '%-6s   %-6s  %5i %10.5f  %10.5f  %10.5f  %10.2f\r\n', Bond_order{i,:});
            end
        end
    end
end

fprintf(fid, '\r\n');

if exist('angletypes','var')
    fprintf(fid, '[ angletypes ] \r\n');
    fprintf(fid, '%s\r\n',';  ai    aj    ak   funct       c0        c1        c2         c3');
    if numel(itp.angletypes)>0
        for i = 1:size(itp.angletypes.ai,1)
            if numel(fieldnames(itp.angletypes))==5 && ~isnan(itp.angletypes.c0(i))
                Angle_order(i,:)= {char(itp.angletypes.ai(i)),char(itp.angletypes.aj(i)),char(itp.angletypes.ak(i)),itp.angletypes.funct(i),itp.angletypes.c0(i)};
                fprintf(fid, '%-6s   %-6s   %-6s   %3i  %10.5f\r\n', Angle_order{i,:});
            elseif numel(fieldnames(itp.angletypes))==6 && ~isnan(itp.angletypes.c1(i))
                Angle_order(i,:)= {char(itp.angletypes.ai(i)),char(itp.angletypes.aj(i)),char(itp.angletypes.ak(i)),itp.angletypes.funct(i),itp.angletypes.c0(i),itp.angletypes.c1(i)};
                fprintf(fid, '%-6s   %-6s   %-6s   %3i  %10.5f %10.2f\r\n', Angle_order{i,:});
            elseif numel(fieldnames(itp.angletypes))==7 && ~isnan(itp.angletypes.c2(i))
                Angle_order(i,:)= {char(itp.angletypes.ai(i)),char(itp.angletypes.aj(i)),char(itp.angletypes.ak(i)),itp.angletypes.funct(i),itp.angletypes.c0(i),itp.angletypes.c1(i),itp.angletypes.c2(i)};
                fprintf(fid, '%-6s   %-6s   %-6s   %3i  %10.5f  %10.5f %10.2f\r\n', Angle_order{i,:});
            elseif numel(fieldnames(itp.angletypes))==8 && ~isnan(itp.angletypes.c3(i))
                Angle_order(i,:)= {char(itp.angletypes.ai(i)),char(itp.angletypes.aj(i)),char(itp.angletypes.ak(i)),itp.angletypes.funct(i),itp.angletypes.c0(i),itp.angletypes.c1(i),itp.angletypes.c2(i),itp.angletypes.c3(i)};
                fprintf(fid, '%-6s   %-6s   %-6s   %3i  %10.5f  %10.5f  %10.5f %10.2f\r\n', Angle_order{i,:});
            end
        end
    end
end

fprintf(fid, '\r\n');

if exist('dihedraltypes','var')
    fprintf(fid, '[ dihedraltypes ] \r\n');
    fprintf(fid, '%s\r\n',';  ai    aj    ak    al funct            c0            c1            c2  ');
    if numel(itp.dihedraltypes)>0
        for i = 1:size(itp.dihedraltypes.ai,1)
            if numel(fieldnames(itp.dihedraltypes))==8
                if isfield(itp.dihedraltypes,'c0') && ~isnan(itp.dihedraltypes.c0(i))
                    Dihedral_order(i,:)= {char(itp.dihedraltypes.ai(i)),char(itp.dihedraltypes.aj(i)),char(itp.dihedraltypes.ak(i)),char(itp.dihedraltypes.al(i)),itp.dihedraltypes.funct(i),itp.dihedraltypes.c0(i),itp.dihedraltypes.c1(i),itp.dihedraltypes.c2(i)};
                    fprintf(fid, '%6s   %6s   %6s   %6s %3i   %10.5f   %10.5f   %3i\r\n', Dihedral_order{i,:});
                else
                    disp('Did not write all dihedral params, need to edit a new section for that...')
                end
            end
        end
    end
end

fprintf(fid, '\r\n');

if exist('dihedraltypes2','var')
    fprintf(fid, '[ dihedraltypes ] \r\n');
    fprintf(fid, '%s\r\n',';  ai    aj    ak    al funct            c0            c1  ');
    if numel(itp.dihedraltypes2)>0
        for i = 1:size(itp.dihedraltypes2.ai,1)
            if numel(fieldnames(itp.dihedraltypes2))==7
                if isfield(itp.dihedraltypes2,'c0') && ~isnan(itp.dihedraltypes2.c0(i))
                    Dihedral2_order(i,:)= {char(itp.dihedraltypes2.ai(i)),char(itp.dihedraltypes2.aj(i)),char(itp.dihedraltypes2.ak(i)),char(itp.dihedraltypes2.al(i)),itp.dihedraltypes2.funct(i),itp.dihedraltypes2.c0(i),itp.dihedraltypes2.c1(i)};
                    fprintf(fid, '%6s   %6s   %6s   %6s %3i   %10.5f   %10.5f\r\n', Dihedral2_order{i,:});
                else
                    disp('Did not write all dihedral params, need to edit a new section for that...')
                end
            end
        end
    end
end

fprintf(fid, '\r\n');

if exist('moleculetype','var')
    fprintf(fid, '%s\r\n','[ moleculetype ]');
    fprintf(fid, '%s % s\r\n',';','molname   nrexcl');
    fprintf(fid, '%s       %d\r\n',char(itp.moleculetype.moleculetype),str2double(itp.moleculetype.nrexcl));
    fprintf(fid, '\r\n');
end

if exist('atoms','var')
    fprintf(fid, '%s\r\n','[ atoms ]');
    fprintf(fid, '%s\r\n',';    nr       type resnr residue  atom   cgnr     charge       mass     ; comment');
    ChargeSumColumn=round2dec(cumsum(itp.atoms.charge),5);
    for i = 1:size(itp.atoms.nr,1)
        atoms_section(i,:) = {itp.atoms.nr(i), char(atoms.type(i)),itp.atoms.resnr(i),char(itp.atoms.residue(i)),char(itp.atoms.atom(i)),itp.atoms.nr(i), scale_charge*itp.atoms.charge(i),itp.atoms.mass(i), '; qtot ', scale_charge*ChargeSumColumn(i)};
        fprintf(fid, '%6i%11s%9i%5s%7s%7i\t%8.5f\t%8.4f\t%5s\t%8.5f\r\n',atoms_section{i,:});
    end
end

fprintf(fid, '\r\n');

if exist('pairs','var')
    fprintf(fid, '[ pairs ] \r\n');
    fprintf(fid, '%s\r\n',';  ai    aj funct            c0            c1            c2            c3');
    if numel(itp.pairs)>0
        for i = 1:size(itp.pairs.ai,1)
            if numel(fieldnames(itp.pairs))<5
                if isfield(itp.pairs,'c0')% ~isnan(itp.pairs.c0(i))
                    Pair_order(i,:)= {itp.pairs.ai(i),itp.pairs.aj(i),itp.pairs.funct(i),itp.pairs.c0(i),';',char(itp.atoms.atom(itp.pairs.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.pairs.aj(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %12.2e %s %s %s\r\n', Pair_order{i,:});
                else
                    Pair_order(i,:)= {itp.pairs.ai(i),itp.pairs.aj(i),itp.pairs.funct(i),';',char(itp.atoms.atom(itp.pairs.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.pairs.aj(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %s %s %s\r\n', Pair_order{i,:});
                end
            elseif isnan(itp.pairs.c0(i))
                Pair_order(i,:)= {itp.pairs.ai(i),itp.pairs.aj(i),itp.pairs.funct(i),';',char(itp.atoms.atom(itp.pairs.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.pairs.aj(i)==itp.atoms.nr))};
                fprintf(fid, '%5i %5i %5i %s %s %s\r\n', Pair_order{i,:});
            else
                disp('Did not write all pair params, need to edit a new section for that...')
            end
        end
    end
end

fprintf(fid, '\r\n');

if exist('bonds','var')
    fprintf(fid, '[ bonds ] \r\n');
    fprintf(fid, '%s\r\n',';  ai    aj funct       c0        c1        c2         c3');
    if numel(itp.bonds)>0
        for i = 1:size(itp.bonds.ai,1)
            if numel(fieldnames(itp.bonds))<5
                if isfield(itp.bonds,'c0') && ~isnan(itp.bonds.c0(i)) && ~itp.bonds.c0(i)==0
                    Bond_order(i,:)= {itp.bonds.ai(i),itp.bonds.aj(i),itp.bonds.funct(i),itp.bonds.c0(i),';',char(itp.atoms.atom(itp.bonds.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.bonds.aj(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %10.5f %s %s %s\r\n', Bond_order{i,:});
                else
                    Bond_order(i,:)= {itp.bonds.ai(i),itp.bonds.aj(i),itp.bonds.funct(i),';',char(itp.atoms.atom(itp.bonds.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.bonds.aj(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %s %s %s\r\n', Bond_order{i,:});
                end
            elseif numel(fieldnames(itp.bonds))<6
                if isfield(itp.bonds,'c1') && ~isnan(itp.bonds.c0(i)) && ~itp.bonds.c0(i)==0
                    Bond_order(i,:)= {itp.bonds.ai(i),itp.bonds.aj(i),itp.bonds.funct(i),itp.bonds.c0(i),itp.bonds.c1(i),';',char(itp.atoms.atom(itp.bonds.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.bonds.aj(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %10.5f %10.2f %s %s %s\r\n', Bond_order{i,:});
                else
                    numel(fieldnames(itp.bonds))
                    fieldnames(itp.bonds)
                    disp('Did not write all bonded params, need to edit a new section for that...')
                end
            else
                numel(fieldnames(itp.bonds))
                fieldnames(itp.bonds)
                disp('Did not write all bonded params, need to edit a new section for that...')
            end
        end
    end
end

fprintf(fid, '\r\n');


if exist('angles','var')
    fprintf(fid, '[ angles ] \r\n');
    fprintf(fid, '%s\r\n',';  ai    aj    ak  funct      c0           c1         c2         c3');
    if numel(itp.angles)>0
        for i = 1:size(itp.angles.ai,1)
            if numel(fieldnames(itp.angles))<6
                if isfield(itp.angles,'c0') && ~isnan(itp.angles.c0(i)) && ~itp.angles.c0(i)==0
                    Angle_order(i,:)= {itp.angles.ai(i),itp.angles.aj(i),itp.angles.ak(i),itp.angles.funct(i),itp.angles.c0(i),';',char(itp.atoms.atom(itp.angles.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.ak(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %5i %10.2f %s %s %s %s\r\n', Angle_order{i,:});
                else
                    Angle_order(i,:)= {itp.angles.ai(i),itp.angles.aj(i),itp.angles.ak(i),itp.angles.funct(i),';',char(itp.atoms.atom(itp.angles.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.ak(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %5i %s %s %s %s\r\n', Angle_order{i,:});
                end
            elseif numel(fieldnames(itp.angles))<7
                if isfield(itp.angles,'c1') && ~isnan(itp.angles.c0(i)) && ~itp.angles.c0(i)==0
                    Angle_order(i,:)= {itp.angles.ai(i),itp.angles.aj(i),itp.angles.ak(i),itp.angles.funct(i),itp.angles.c0(i),itp.angles.c1(i),';',char(itp.atoms.atom(itp.angles.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.angles.ak(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %5i %10.2f %10.2f %s %s %s %s\r\n', Angle_order{i,:});
                end
            else
                disp('Did not write all angle params, need to edit a new section for that...')
            end
        end
    end
end

fprintf(fid, '\r\n');

if exist('exclusions','var')
    fprintf(fid, '[ exclusions ] \r\n');
    fprintf(fid, '%s\r\n',';  ai    aj    ak  funct');
    if numel(itp.exclusions)>0
        for i = 1:size(itp.exclusions.ai,1)
            if numel(fieldnames(itp.exclusions))<5
                if ~isnan(itp.exclusions.c0(i))
                    Exclusion_order(i,:)= {itp.exclusions.ai(i),itp.exclusions.aj(i),itp.exclusions.ak(i),itp.exclusions.funct(i),itp.exclusions.c0(i)};
                    fprintf(fid, '%5i %5i %5i %5i %8.2f\r\n', Exclusion_order{i,:});
                else
                    Exclusion_order(i,:)= {itp.exclusions.ai(i),itp.exclusions.aj(i),itp.exclusions.ak(i),itp.exclusions.funct(i)};
                    fprintf(fid, '%5i %5i %5i %5i\r\n', Exclusion_order{i,:});
                end
            else
                disp('Did not write all exclusion params, need to edit a new section for that...')
            end
        end
    end
end

fprintf(fid, '\r\n');

if exist('dihedrals','var')
    fprintf(fid, '[ dihedrals ] \r\n');
    fprintf(fid, '%s\r\n',';  ai    aj    ak    al funct            c0            c1            c2            c3            c4            c5');
    if numel(itp.dihedrals)>0
        for i = 1:size(itp.dihedrals.ai,1)
            if numel(fieldnames(itp.dihedrals))<7
                if isfield(itp.dihedrals,'c0') && ~isnan(itp.dihedrals.c0(i))
                    Dihedral_order(i,:)= {itp.dihedrals.ai(i),itp.dihedrals.aj(i),itp.dihedrals.ak(i),itp.dihedrals.al(i),itp.dihedrals.funct(i),itp.dihedrals.c0(i),';',char(itp.atoms.atom(itp.dihedrals.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.al(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %5i %5i %8.2f %s %s %s %s %s\r\n', Dihedral_order{i,:});
                else
                    Dihedral_order(i,:)= {itp.dihedrals.ai(i),itp.dihedrals.aj(i),itp.dihedrals.ak(i),itp.dihedrals.al(i),itp.dihedrals.funct(i),';',char(itp.atoms.atom(itp.dihedrals.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.al(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %5i %5i %s %s %s %s %s\r\n', Dihedral_order{i,:});
                end
            elseif numel(fieldnames(itp.dihedrals))<8
                if isfield(itp.dihedrals,'c2') && ~isnan(itp.dihedrals.c2(i))
                    Dihedral_order(i,:)= {itp.dihedrals.ai(i),itp.dihedrals.aj(i),itp.dihedrals.ak(i),itp.dihedrals.al(i),itp.dihedrals.funct(i),itp.dihedrals.c0(i),itp.dihedrals.c1(i),';',char(itp.atoms.atom(itp.dihedrals.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.al(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %5i %5i %8.2f %8.4f %s %s %s %s %s\r\n', Dihedral_order{i,:});
                end
            elseif numel(fieldnames(itp.dihedrals))>8
                if isfield(itp.dihedrals,'c2') && ~isnan(itp.dihedrals.c2(i))
                    Dihedral_order(i,:)= {itp.dihedrals.ai(i),itp.dihedrals.aj(i),itp.dihedrals.ak(i),itp.dihedrals.al(i),itp.dihedrals.funct(i),itp.dihedrals.c0(i),itp.dihedrals.c1(i),itp.dihedrals.c2(i),';',char(itp.atoms.atom(itp.dihedrals.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.dihedrals.al(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %5i %5i %8.2f %8.4f %5i %s %s %s %s %s\r\n', Dihedral_order{i,:});
                end
            else
                disp('Did not write all dihedral params, need to edit a new section for that...')
            end
        end
    end
end

fprintf(fid, '\r\n');

if exist('impropers','var')
    fprintf(fid, '[ impropers ] \r\n');
    fprintf(fid, '%s\r\n',';  ai    aj    ak    al funct            c0            c1            c2            c3            c4            c5');
    if numel(itp.impropers)>0
        for i = 1:size(itp.impropers.ai,1)
            if numel(fieldnames(itp.impropers))<7
                if isfield(itp.impropers,'c0') && ~isnan(itp.impropers.c0(i))
                    Improper_order(i,:)= {itp.impropers.ai(i),itp.impropers.aj(i),itp.impropers.ak(i),itp.impropers.al(i),itp.impropers.funct(i),itp.impropers.c0(i),';',char(itp.atoms.atom(itp.impropers.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.al(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %5i %5i %8.2f %s %s %s %s %s\r\n', Improper_order{i,:});
                else
                    Improper_order(i,:)= {itp.impropers.ai(i),itp.impropers.aj(i),itp.impropers.ak(i),itp.impropers.al(i),itp.impropers.funct(i),';',char(itp.atoms.atom(itp.impropers.ai(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.aj(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.ak(i)==itp.atoms.nr)),char(itp.atoms.atom(itp.impropers.al(i)==itp.atoms.nr))};
                    fprintf(fid, '%5i %5i %5i %5i %5i %s %s %s %s %s\r\n', Improper_order{i,:});
                end
            else
                disp('Did not write all improper params, need to edit a new section for that...')
            end
        end
    end
end

fprintf(fid, '\r\n');

if exist('enddata','var')
    end_string=cellstr(itp.enddata);
    fprintf(fid, '%s \r\n',end_string{:});
end

fprintf(fid, '\r\n');

fclose(fid);


##### SOURCE END #####
-->
</body>
</html>
